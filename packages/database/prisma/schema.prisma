// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum CrewStatus {
  active
  inactive
  on_leave
  terminated
}

enum CertificateStatus {
  valid
  expiring_soon
  expired
  revoked
}

enum ContractStatus {
  active
  completed
  terminated
  pending
}

enum VesselStatus {
  operational
  maintenance
  laid_up
  decommissioned
}

enum Rank {
  master
  chief_engineer
  chief_officer
  second_officer
  third_officer
  chief_mate
  second_mate
  third_mate
  able_seaman
  ordinary_seaman
  oiler
  wiper
  cook
  steward
  cadet
}

enum VerificationStatus {
  pending
  verified
  rejected
}

// Models
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model CrewMaster {
  id           String     @id @default(cuid())
  employeeId   String     @unique
  firstName    String
  lastName     String
  dateOfBirth  DateTime
  nationality  String
  email        String?    @unique
  phone        String?
  status       CrewStatus @default(active)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  certificates CrewCertificate[]
  contracts    CrewContract[]
  assignments  CrewAssignment[]
  renewalPlans CertificateRenewalPlan[]
  travel       CrewTravel[]

  @@index([status])
  @@index([employeeId])
  @@map("crew_masters")
}

model CertificateType {
  id                  String   @id @default(cuid())
  code                String   @unique
  name                String
  category            String
  validityPeriodMonths Int?
  mandatory           Boolean  @default(false)
  description         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  certificates        CrewCertificate[]

  @@index([category])
  @@index([mandatory])
  @@map("certificate_types")
}

model CrewCertificate {
  id                 String            @id @default(cuid())
  crewId             String
  certificateTypeId  String
  certificateNumber  String
  issueDate          DateTime
  expiryDate         DateTime
  documentUrl        String?
  verificationStatus VerificationStatus @default(pending)
  status             CertificateStatus @default(valid)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  crew               CrewMaster        @relation(fields: [crewId], references: [id], onDelete: Cascade)
  certificateType    CertificateType   @relation(fields: [certificateTypeId], references: [id], onDelete: Restrict)
  renewalPlans       CertificateRenewalPlan[]

  @@index([crewId])
  @@index([certificateTypeId])
  @@index([expiryDate])
  @@index([status])
  @@index([verificationStatus])
  @@unique([crewId, certificateTypeId, certificateNumber])
  @@map("crew_certificates")
}

model Vessel {
  id               String       @id @default(cuid())
  imoNumber        String       @unique
  vesselName       String
  vesselType       String
  flagState        String
  grossTonnage     Float?
  operationalStatus VesselStatus @default(operational)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  contracts        CrewContract[]
  assignments      CrewAssignment[]
  rotationPlans     RotationPlan[]
  emergencies      EmergencyReplacement[]

  @@index([imoNumber])
  @@index([operationalStatus])
  @@map("vessels")
}

model CrewContract {
  id            String        @id @default(cuid())
  crewId        String
  vesselId      String
  rank          Rank
  signOnDate    DateTime
  contractEndDate DateTime
  status        ContractStatus @default(active)
  basicWage     Float?
  signOnPort    String?
  signOffPort   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  crew          CrewMaster    @relation(fields: [crewId], references: [id], onDelete: Cascade)
  vessel        Vessel        @relation(fields: [vesselId], references: [id], onDelete: Restrict)
  restHours     RestHourRecord[]
  travelBookings CrewTravel[]

  @@index([crewId])
  @@index([vesselId])
  @@index([status])
  @@index([contractEndDate])
  @@map("crew_contracts")
}

// Agent Workflow Models
enum AgentType {
  crew_match
  rotation_planner
  fatigue_guardian
  cert_guardian
  travel_coordinator
  emergency_crew
}

enum AgentMessageType {
  request_assignment
  response_assignment
  alert
  notification
  status_update
}

enum AgentMessagePriority {
  low
  medium
  high
  critical
}

model AgentMessage {
  id              String            @id @default(cuid())
  agentId         String
  agentType       AgentType
  messageType     AgentMessageType
  priority        AgentMessagePriority @default(medium)
  payload         Json
  requestingAgent String?
  status          String            @default("pending")
  response        Json?
  createdAt       DateTime          @default(now())
  processedAt     DateTime?
  error           String?

  @@index([agentId])
  @@index([agentType])
  @@index([messageType])
  @@index([priority])
  @@index([status])
  @@index([createdAt])
  @@map("agent_messages")
}

model CrewAssignment {
  id                  String   @id @default(cuid())
  crewId              String
  vesselId             String
  rank                Rank
  requiredDate        DateTime
  port                String
  assignmentScore     Float?
  technicalScore      Float?
  performanceScore    Float?
  costScore           Float?
  preferenceScore     Float?
  continuityScore     Float?
  riskAssessment      Json?
  status              String   @default("pending")
  assignedBy          String?  // agent_id
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  crew                CrewMaster @relation(fields: [crewId], references: [id], onDelete: Cascade)
  vessel              Vessel      @relation(fields: [vesselId], references: [id], onDelete: Restrict)

  @@index([crewId])
  @@index([vesselId])
  @@index([status])
  @@index([requiredDate])
  @@map("crew_assignments")
}

model RotationPlan {
  id                  String   @id @default(cuid())
  vesselId             String
  planningPeriodStart  DateTime
  planningPeriodEnd    DateTime
  planData             Json     // Contains rotation schedule
  costProjection       Float?
  confidenceLevel      Float?
  riskAssessment       Json?
  status               String   @default("draft")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  vessel               Vessel   @relation(fields: [vesselId], references: [id], onDelete: Cascade)

  @@index([vesselId])
  @@index([planningPeriodStart])
  @@index([status])
  @@map("rotation_plans")
}

// Rest Hour Compliance Models
model RestHourRecord {
  id              String   @id @default(cuid())
  contractId      String
  crewId          String
  recordDate      DateTime
  workHours       Float
  restHours       Float
  restPeriods     Json     // Array of rest periods
  complianceStatus String  @default("compliant") // compliant, violation_minimum, violation_split, violation_weekly
  violationType   String?
  fatigueRiskScore Float?
  masterApproved  Boolean  @default(false)
  masterSignature String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contract        CrewContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([crewId])
  @@index([recordDate])
  @@index([complianceStatus])
  @@map("rest_hour_records")
}

model WeeklyRestSummary {
  id              String   @id @default(cuid())
  contractId      String
  crewId          String
  weekStartDate   DateTime
  totalRestHours  Float
  complianceStatus String
  shortfallHours  Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([contractId])
  @@index([crewId])
  @@index([weekStartDate])
  @@map("weekly_rest_summaries")
}

// Certificate Renewal Planning
model CertificateRenewalPlan {
  id                  String   @id @default(cuid())
  certificateId       String
  crewId              String
  renewalDate         DateTime
  trainingCenter      String?
  trainingLocation    String?
  estimatedCost       Float?
  travelCost          Float?
  status              String   @default("planned")
  bookedAt            DateTime?
  completedAt         DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  certificate         CrewCertificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)
  crew                CrewMaster      @relation(fields: [crewId], references: [id], onDelete: Cascade)

  @@index([certificateId])
  @@index([crewId])
  @@index([renewalDate])
  @@index([status])
  @@map("certificate_renewal_plans")
}

// Travel Coordination Models
model CrewTravel {
  id                  String   @id @default(cuid())
  contractId          String?
  crewId              String
  travelType          String   // sign_on, sign_off, emergency, training
  origin              String
  destination         String
  departureDate       DateTime
  arrivalDate         DateTime?
  flightDetails       Json?
  hotelDetails        Json?
  visaStatus          String?
  totalCost           Float?
  bookingStatus       String   @default("pending")
  trackingUrl         String?
  disruptions         Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  crew                CrewMaster      @relation(fields: [crewId], references: [id], onDelete: Cascade)
  contract            CrewContract?   @relation(fields: [contractId], references: [id], onDelete: SetNull)

  @@index([crewId])
  @@index([contractId])
  @@index([travelType])
  @@index([bookingStatus])
  @@index([departureDate])
  @@map("crew_travel")
}

// Emergency Crew Replacement
model EmergencyReplacement {
  id                  String   @id @default(cuid())
  vesselId            String
  outgoingCrewId      String
  outgoingRank        Rank
  emergencyType       String   // medical, family, visa, behavioral, covid
  severity            String   // immediate, high, medium, low
  replacementCrewId   String?
  replacementRank     Rank
  requiredArrivalDate DateTime
  actualArrivalDate   DateTime?
  status              String   @default("active")
  costPremium         Float?
  vesselDelayHours    Float?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  vessel              Vessel   @relation(fields: [vesselId], references: [id], onDelete: Cascade)

  @@index([vesselId])
  @@index([outgoingCrewId])
  @@index([status])
  @@index([severity])
  @@map("emergency_replacements")
}
